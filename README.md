# STM32F103C8T6 Quadrature Clock Generator

A true quadrature square wave generator using an STM32F103C8T6 microcontroller that generates proper quadrature encoding signals on 4 output pins with adjustable frequency controlled by a potentiometer. Features true quadrature with inverted channel pairs and 90-degree phase shifts.

## Features

- **True Quadrature Output Generation**: Uses coupled hardware timers (TIM1 and TIM2) to generate true quadrature signals with 90-degree phase shift and channel inversions
- **Extended Frequency Range**: Potentiometer control allows frequency adjustment between 1Hz and 100kHz (restored and enhanced)
- **Dynamic Timer Optimization**: Automatic prescaler calculation ensures optimal resolution across the entire frequency range
- **Button Control**: Enable/disable buttons for output control with debouncing
- **Status LED**: Visual indication of output state
- **UART Communication**: Real-time status reporting via serial interface with frequency validation
- **50% Duty Cycle**: Maintains consistent duty cycle across frequency range
- **Hardware-based PWM**: Uses STM32F103 hardware timers for precise timing
- **Robust Design**: Input validation and error handling for reliable operation

## Hardware Requirements

- STM32F103C8T6 "Blue Pill" development board
- Potentiometer (10kΩ recommended) connected to PA0 (ADC input)
- Two push buttons:
  - Enable button connected to PA12 (with pull-up)
  - Disable button connected to PA15 (with pull-up) 
- Status LED connected to PC13 (built-in LED on Blue Pill)
- UART connection on PA2 (TX) and PA3 (RX) for status monitoring
- 4 output pins for quadrature signals:
  - PA8 (TIM1_CH1) - Output A
  - PA9 (TIM1_CH2) - Output B  
  - PA10 (TIM2_CH3) - Output C
  - PA11 (TIM2_CH4) - Output D

## Pin Configuration

| Function | Pin | Description |
|----------|-----|-------------|
| ADC Input | PA0 | Potentiometer for frequency control |
| UART TX | PA2 | Status output transmission |
| UART RX | PA3 | Serial communication receive |
| Quad Out A | PA8 | First quadrature output |
| Quad Out B | PA9 | Second quadrature output |
| Quad Out C | PA10 | Third quadrature output (90° shift) |
| Quad Out D | PA11 | Fourth quadrature output (90° shift) |
| Enable Button | PA12 | Button to enable output |
| Status LED | PC13 | Output status indicator |
| Disable Button | PA15 | Button to disable output |

## Software Architecture

- **Main Loop**: Continuously monitors ADC and button states
- **Timer Configuration**: TIM1 and TIM2 configured with phase shift for quadrature output
- **Interrupt Handling**: Button debouncing using GPIO interrupts
- **ADC Conversion**: Maps potentiometer position to frequency range
- **UART Reporting**: Periodic status transmission

## Build Instructions

### Prerequisites

- ARM GCC toolchain (`arm-none-eabi-gcc`)
- CMake (version 3.20 or higher)
- STM32 HAL libraries (automatically downloaded)

### Setup

1. Clone the repository:
```bash
git clone https://github.com/inthewhirlwind/stm32f103-8-bit-clock-generator.git
cd stm32f103-8-bit-clock-generator
```

2. Download STM32 HAL libraries:
```bash
./scripts/download_hal.sh
```

3. Create build directory:
```bash
mkdir build && cd build
```

4. Configure and build:
```bash
cmake ..
make
```

### Flashing

Flash the generated binary using your preferred method:

```bash
# Using st-flash
st-flash write stm32f103-quadrature-generator.bin 0x8000000

# Using OpenOCD
openocd -f interface/stlink-v2.cfg -f target/stm32f1x.cfg -c "program stm32f103-quadrature-generator.elf verify reset exit"
```

## Usage

1. **Power on** the STM32F103C8T6 board
2. **Connect UART** at 115200 baud to monitor status
3. **Adjust potentiometer** to change output frequency (1Hz - 100kHz)
4. **Press enable button** to start quadrature output generation
5. **Press disable button** to stop output generation
6. **Monitor LED** for output status indication

## UART Output Format

The system sends status information every 500ms:
```
STM32F103 Quadrature Generator v1.0
ADC: 2048, Freq: 50250Hz, Output: ON
ADC: 1024, Freq: 25000Hz, Output: ON
ADC: 0, Freq: 1Hz, Output: OFF
```

## Quadrature Output Timing

- **Channels A & B**: Generated by TIM1 (PA8, PA9) - primary quadrature pair where B is inverted from A
- **Channels C & D**: Generated by TIM2 (PA10, PA11) - secondary pair with 90° phase lead where D is inverted from C
- **Duty Cycle**: 50% on all channels for optimal signal integrity
- **Phase Relationship**: True quadrature encoding with 90° phase shifts and channel inversions
  - Channel B is 180° out of phase with Channel A
  - Channel D is 180° out of phase with Channel C
  - Channels C & D lead A & B by 90 degrees (quarter cycle)
- **Frequency Range**: 1Hz to 100kHz with dynamic prescaler optimization
- **Resolution**: Variable resolution based on frequency range (optimal timer utilization)
- **Timing Accuracy**: Hardware PWM ensures precise timing and low jitter

### Quadrature Waveform Diagram

The following diagram illustrates the timing relationship between all four output channels:

```
Time →  0°      90°     180°    270°    360°    450°    540°    630°    720°
        │       │       │       │       │       │       │       │       │

CH A ── ┌───────┐       ┌───────┐       ┌───────┐       ┌───────┐       ┌──
(PA8)   │       │       │       │       │       │       │       │       │
     ───┘       └───────┘       └───────┘       └───────┘       └───────┘

CH B ───────────┐       ┌───────┐       ┌───────┐       ┌───────┐       ┌
(PA9)           │       │       │       │       │       │       │       │
     ───────────┘       └───────┘       └───────┘       └───────┘       └

CH C ───────┌───────┐       ┌───────┐       ┌───────┐       ┌───────┐    
(PA10)      │       │       │       │       │       │       │       │    
     ───────┘       └───────┘       └───────┘       └───────┘       └────

CH D ───────────────┐       ┌───────┐       ┌───────┐       ┌───────┐    
(PA11)              │       │       │       │       │       │       │    
     ───────────────┘       └───────┘       └───────┘       └───────┘    

Legend:
  • CH A & B: TIM1 channels (PA8, PA9) - B is inverted from A (180° phase difference)
  • CH C & D: TIM2 channels (PA10, PA11) - D is inverted from C (180° phase difference)
  • Phase Relationship: C & D lead A & B by 90° (quarter cycle advance)
  • All channels: 50% duty cycle, synchronized start/stop control
```

**Key Timing Characteristics:**
- **90° Phase Lead**: Channels C & D start 90° ahead of A & B
- **Inverse Pairs**: B is inverted from A, D is inverted from C
- **True Quadrature**: Provides directional encoding capability
- **Synchronized Operation**: All channels start/stop together when enabled/disabled

### Dynamic Frequency Scaling

The system automatically adjusts timer prescaler values to maintain optimal resolution across the wide frequency range:

- **Low frequencies (1-100Hz)**: High prescaler values for fine resolution
- **Mid frequencies (100Hz-10kHz)**: Balanced prescaler for good accuracy  
- **High frequencies (10kHz-100kHz)**: Low prescaler values for fast response

This approach ensures consistent quadrature output quality across the entire range.

## Project Structure

```
├── CMakeLists.txt          # Build configuration
├── README.md               # This file
├── STM32F103C8Tx_FLASH.ld  # Linker script
├── cmake/                  # CMake toolchain files
├── include/                # Header files
│   ├── main.h
│   ├── stm32f1xx_hal_conf.h
│   └── stm32f1xx_it.h
├── lib/                    # STM32 HAL libraries
├── scripts/                # Utility scripts
└── src/                    # Source code
    ├── main.c              # Main application
    ├── stm32f1xx_hal_msp.c # Hardware initialization
    ├── stm32f1xx_it.c      # Interrupt handlers
    ├── startup_stm32f103c8tx.s # Startup code
    └── system_stm32f1xx.c  # System configuration
```

## Development Notes

- Built with STM32 HAL library for portability
- Uses hardware PWM for precise timing
- Implements proper button debouncing
- Modular code structure for easy modification
- Well-documented for educational purposes

## License

This project is provided as-is for educational and development purposes.
